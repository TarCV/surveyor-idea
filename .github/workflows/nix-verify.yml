name: Fetch from Garnix
on:
  check_run:
    types: [completed]

jobs:
  verifyReproducible:
    name: Compare with Garnix artefact
    if: >-
      github.event.check_run.app.name == 'Garnix CI'
      && contains(github.event.check_run.name, 'default package')
    runs-on: ubuntu-latest
    steps:
      - uses: lewagon/wait-on-check-action@v1.3.1
        with:
          ref: ${{github.event.check_run.head_sha}}
          check-name: 'Build'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Sleep
        run: sleep 15s
        shell: bash
      - uses: dawidd6/action-download-artifact@v2
        with:
          workflow: build.yml
          commit: ${{github.event.check_run.head_sha}}
          name: ".+[Ss]urveyor-\\d.+"
          name_is_regexp: true
          path: gha-artefact
      - run: |
          ls -R .
      - uses: cachix/install-nix-action@v20
      - run: |
          cat <<- 'EOF' | grep -P --only-matching '\/nix\/store\/\K\S+(?=-gradleBuild)' | tail -n 1 | curl "https://cache.garnix.io/$(cat).narinfo" | tee _narinfo
            ${{ github.event.check_run.output.text }}
          EOF
          echo '=========='
          curl --verbose --output _artefact.nar "https://cache.garnix.io/$(grep -P --only-matching 'URL:\s*\K\S+' <_narinfo)"
          nix-store --restore ./artefact <_artefact.nar && rm _*
          ls -R .
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: artefact-from-garnix
          path: ./artefact/*
      - name: Verify same (i.e. reproducible)
        run: |
          cmp -b gha-artefact/*/* artefact/*
